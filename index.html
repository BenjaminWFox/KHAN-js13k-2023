<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>JS13K Demo</title>
  <script type="module" src="/src/index.ts"></script>
  <script type="text/javascript">
    // const createP1 = function(){var e,r,a,$,t,_={},n=[...Array(12).keys()].map(e=>new AudioContext),f=(e,r)=>Math.sin(6.28*e+r),p=e=>f(e,f(e,0)**2+.75*f(e,.25)+.1*f(e,.5)),o=(e,r,a)=>{var t=e+""+r,f=_[t];if(e>=0&&!f){e=65.406*1.06**e/a;var o,i=a*r|0,s=a*(r-.002);for(o=(f=_[t]=n[0].createBuffer(1,i,a)).getChannelData(0);i--;)o[i]=(i<88?i/88.2:(1-(i-88.2)/s)**(Math.log(1e4*e)/2)**2)*p(i*e);$||n.map(e=>c(f,e,$=1))}return f},c=(e,r,a)=>{var $=r.createBufferSource();$.buffer=e,$.connect(r.destination),$.start(),a&&$.stop()};p1=$=>{var _=125,f=.5;e=$[r=0].replace(/[\!\|]/g,"").split("\n").map(e=>e>0?(_=(e=e.split("."))[0],f=e[1]/100||f):e.split("").map((a,$)=>{console.log('doing something');var t=1,n=a.charCodeAt(0);for(n-=n>90?71:65;"-"==e[$+t];)t++;return r<$&&(r=$+1),o(n,t*f*_/125,44100)})),t=0,clearInterval(a),a=setInterval(a=>{e.map((e,r)=>{e[a=t%e.length]&&c(e[a],n[3*r+t%3])}),t++,t%=r},_)}};
    const createP1 = function() {
      var buffers = {},
        contexts = [...Array(12).keys()].map(_=>new AudioContext),
        tracks,
        trackLen,
        interval,
        unlocked,
        noteI,
        // Modulation. Generates a sample of a sinusoidal signal with a specific frequency and amplitude.
        b = (note, add) => Math.sin(note*6.28 + add),
        // Instrument synthesis.
        pianoify = (note) => b(note, b(note,0)**2 + b(note,.25)*.75 + b(note,.5)*.1)
      
      var makeNote = (note, seconds, sampleRate) => {
        var key = note+''+seconds
        var buffer = buffers[key]
        if(note>=0 && !buffer) {
          
          // Calculate frequency/pitch. "Low C" is 65.406
          note = 65.406 * 1.06 ** note / sampleRate
          
          var i = sampleRate * seconds | 0,
            sampleRest = sampleRate * (seconds - .002),
            bufferArray
          buffer = buffers[key] = contexts[0].createBuffer(1, i, sampleRate)
          bufferArray = buffer.getChannelData(0)
          
          // Fill the samples array
          for(;i--;) {
            bufferArray[i] =
              // The first 88 samples represent the note's attack
              (i < 88 ?
                i / 88.2
                // The other samples represent the rest of the note
                : (1 - (i - 88.2) / sampleRest) ** ((Math.log(1e4 * note) / 2) ** 2)
              ) * pianoify(i * note)
          }
          
          // Safari hack: Play every audioContext then stop them immediately to "unlock" them on ios.
          if(!unlocked) {
            contexts.map(context => playBuffer(buffer, context, unlocked=1))
          }
        }
        return buffer
      }
      
      var playBuffer = (buffer, context, stop) => {
        var gain = context.createGain()
        gain.gain.value = 0.05;
        gain.connect(context.destination)
        var source = context.createBufferSource()
        source.buffer = buffer
        source.connect(gain)
        source.start()
        stop && source.stop()
      }
      
      p1 = (params) => {
        var tempo = 125, noteLen = .5
        tracks = params[trackLen = 0].replace(/[\!\|]/g,'').split('\n').map(track =>
          track>0 ?
            (
              track = track.split('.'),
              tempo = track[0],
              noteLen = track[1]/100 || noteLen
            )
          :
            track.split('').map((letter, i) => {
              var duration = 1,
                note = letter.charCodeAt(0)
              note -= note>90 ? 71 : 65
              while(track[i+duration]=='-') {
                duration++
              }
              if(trackLen<i)trackLen=i+1
              return makeNote(note, duration*noteLen*tempo/125, 44100)
            })
        )
        
        noteI = 0
        clearInterval(interval)
        interval = setInterval(j => {
          tracks.map((track,trackI) => {
            if(track[j = noteI % track.length]) {
              playBuffer(track[j], contexts[trackI*3+noteI%3])
            }
          })
          noteI++
          noteI %= trackLen
        }, tempo)
      }
    }
  </script>
  <link rel="stylesheet" href="/context.css" />
  <link rel="stylesheet" href="/sprites.css" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/title.css" />
  <link rel="stylesheet" href="/card.css" />
</head>

<body>
  <div id="board">
    <div id="overlay"></div>
    <div id="context" class="hide">
      <div id="message" class="pixel-border">
        <div id="content">
        </div>
        <button class="pixel-border" id="context-close">Continue ...</button>
      </div>
    </div>
    <div id="ground"></div>
    <div id="title">
      <h1>KHAN</h1>
      <section id="menu">
        <button id="continue" class="pixel-border">continue</button>
        <button id="new" class="pixel-border">new game</button>
      </section>
    </div>
    <div id="game" class="hide">
      <h2>
        <div id="stage">Stage: 1 / 8</div>
        <div id="round">Round: 1</div>
        <div id="alert"></div>
      </h2>
      <div id="enemy">
      </div>
      <div id="player">
        <button id="endturn" class="pixel-border">End Turn</button>
      </div>
      <div id="deck-done">
        <div id="deck">Deck: 0</div>
        <div id="stamina">Stamina: 0</div>
        <div id="done">Discard: 0</div>
      </div>
      <div id="card-holder">
      </div>
    </div>
  </div>
</body>
</html>
